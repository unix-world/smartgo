// JS-Script (UM): closetag.js @ 2024-12-16 18:40:09 +0000
(function(e){if(typeof exports=="object"&&typeof module=="object"){e(require("../../lib/codemirror"),require("../fold/xml-fold"))}else if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","../fold/xml-fold"],e)}else{e(CodeMirror)}})(function(y){y.defineOption("autoCloseTags",false,function(e,t,n){if(n!=y.Init&&n){e.removeKeyMap("autoCloseTags")}if(!t){return}var r={name:"autoCloseTags"};if(typeof t!="object"||t.whenClosing!==false){r["'/'"]=function(e){return a(e)}}if(typeof t!="object"||t.whenOpening!==false){r["'>'"]=function(e){return o(e)}}e.addKeyMap(r)});var x=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"];var P=["applet","blockquote","body","button","div","dl","fieldset","form","frameset","h1","h2","h3","h4","h5","h6","head","html","iframe","layer","legend","object","ol","p","select","table","ul"];function o(e){if(e.getOption("disableInput")){return y.Pass}var t=e.listSelections(),n=[];var r=e.getOption("autoCloseTags");for(var o=0;o<t.length;o++){if(!t[o].empty()){return y.Pass}var a=t[o].head,i=e.getTokenAt(a);var l=y.innerMode(e.getMode(),i.state),s=l.state;var f=l.mode.xmlCurrentTag&&l.mode.xmlCurrentTag(s);var d=f&&f.name;if(!d){return y.Pass}var u=l.mode.configuration=="html";var c=typeof r=="object"&&r.dontCloseTags||u&&x;var g=typeof r=="object"&&r.indentTags||u&&P;if(i.end>a.ch){d=d.slice(0,d.length-i.end+a.ch)}var m=d.toLowerCase();if(!d||i.type=="string"&&(i.end!=a.ch||!/[\"\']/.test(i.string.charAt(i.string.length-1))||i.string.length==1)||i.type=="tag"&&f.close||i.string.indexOf("/")==a.ch-i.start-1||c&&T(c,m)>-1||j(e,l.mode.xmlCurrentContext&&l.mode.xmlCurrentContext(s)||[],d,a,true)){return y.Pass}var h=typeof r=="object"&&r.emptyTags;if(h&&T(h,d)>-1){n[o]={text:"/>",newPos:y.Pos(a.line,a.ch+2)};continue}var v=g&&T(g,m)>-1;n[o]={indent:v,text:">"+(v?"\n\n":"")+"</"+d+">",newPos:v?y.Pos(a.line+1,0):y.Pos(a.line,a.ch+1)}}var p=typeof r=="object"&&r.dontIndentOnAutoClose;for(var o=t.length-1;o>=0;o--){var b=n[o];e.replaceRange(b.text,t[o].head,t[o].anchor,"+insert");var C=e.listSelections().slice(0);C[o]={head:b.newPos,anchor:b.newPos};e.setSelections(C);if(!p&&b.indent){e.indentLine(b.newPos.line,null,true);e.indentLine(b.newPos.line+1,null,true)}}}function t(e,t){var n=e.listSelections(),r=[];var o=t?"/":"</";var a=e.getOption("autoCloseTags");var i=typeof a=="object"&&a.dontIndentOnSlash;for(var l=0;l<n.length;l++){if(!n[l].empty()){return y.Pass}var s=n[l].head,f=e.getTokenAt(s);var d=y.innerMode(e.getMode(),f.state),u=d.state;if(t&&(f.type=="string"||f.string.charAt(0)!="<"||f.start!=s.ch-1)){return y.Pass}var c,g=d.mode.name!="xml"&&e.getMode().name=="htmlmixed";if(g&&d.mode.name=="javascript"){c=o+"script"}else if(g&&d.mode.name=="css"){c=o+"style"}else{var m=d.mode.xmlCurrentContext&&d.mode.xmlCurrentContext(u);var h=m.length?m[m.length-1]:"";if(!m||m.length&&j(e,m,h,s)){return y.Pass}c=o+h}if(e.getLine(s.line).charAt(f.end)!=">"){c+=">"}r[l]=c}e.replaceSelections(r);n=e.listSelections();if(!i){for(var l=0;l<n.length;l++){if(l==n.length-1||n[l].head.line<n[l+1].head.line){e.indentLine(n[l].head.line)}}}}function a(e){if(e.getOption("disableInput")){return y.Pass}return t(e,true)}y.commands.closeTag=function(e){return t(e)};function T(e,t){if(e.indexOf){return e.indexOf(t)}for(var n=0,r=e.length;n<r;++n){if(e[n]==t){return n}}return-1}function j(e,t,n,r,o){if(!y.scanForClosingTag){return false}var a=Math.min(e.lastLine()+1,r.line+500);var i=y.scanForClosingTag(e,r,null,a);if(!i||i.tag!=n){return false}var l=o?1:0;for(var s=t.length-1;s>=0;s--){if(t[s]==n){++l}else{break}}r=i.to;for(var s=1;s<l;s++){var f=y.scanForClosingTag(e,r,null,a);if(!f||f.tag!=n){return false}r=f.to}return true}});
// #END
