// JS-Script (UM): search.js @ 2025-02-15 03:03:23 +0000
(function(e){if(typeof exports=="object"&&typeof module=="object"){e(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog"))}else if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],e)}else{e(CodeMirror)}})(function(l){"use strict";l.defineOption("search",{bottom:false});function n(t,e){if(typeof t=="string"){t=new RegExp(t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),e?"gi":"g")}else if(!t.global){t=new RegExp(t.source,t.ignoreCase?"gi":"g")}return{token:function(e){t.lastIndex=e.pos;var r=t.exec(e.string);if(r&&r.index==e.pos){e.pos+=r[0].length||1;return"searching"}else if(r){e.pos=r.index}else{e.skipToEnd()}}}}function r(){this.posFrom=this.posTo=this.lastQuery=this.query=null;this.overlay=null}function c(e){return e.state.search||(e.state.search=new r)}function o(e){return typeof e=="string"&&e==e.toLowerCase()}function f(e,r,t){return e.getSearchCursor(r,t,{caseFold:o(r),multiline:true})}function u(e,r,t,n,o){e.openDialog(r,n,{value:t,selectValueOnOpen:true,closeOnEnter:false,onClose:function(){g(e)},onKeyDown:o,bottom:e.options.search.bottom})}function p(e,r,t,n,o){if(e.openDialog){e.openDialog(r,o,{value:n,selectValueOnOpen:true,bottom:e.options.search.bottom})}else{o(prompt(t,n))}}function d(e,r,t,n){if(e.openConfirm){e.openConfirm(r,n)}else if(confirm(t)){n[0]()}}function m(e){return e.replace(/\\([nrt\\])/g,function(e,r){if(r=="n"){return"\n"}if(r=="r"){return"\r"}if(r=="t"){return"\t"}if(r=="\\"){return"\\"}return e})}function i(e){var r=e.match(/^\/(.*)\/([a-z]*)$/);if(r){try{e=new RegExp(r[1],r[2].indexOf("i")==-1?"":"i")}catch(e){}}else{e=m(e)}if(typeof e=="string"?e=="":e.test("")){e=/x^/}return e}function h(e,r,t){r.queryText=t;r.query=i(t);e.removeOverlay(r.overlay,o(r.query));r.overlay=n(r.query,o(r.query));e.addOverlay(r.overlay);if(e.showMatchesOnScrollbar){if(r.annotate){r.annotate.clear();r.annotate=null}r.annotate=e.showMatchesOnScrollbar(r.query,o(r.query))}}function t(i,r,e,t){var n=c(i);if(n.query){return y(i,r)}var o=i.getSelection()||n.lastQuery;if(o instanceof RegExp&&o.source=="x^"){o=null}if(e&&i.openDialog){var a=null;var s=function(e,r){l.e_stop(r);if(!e){return}if(e!=n.queryText){h(i,n,e);n.posFrom=n.posTo=i.getCursor()}if(a){a.style.opacity=1}y(i,r.shiftKey,function(e,r){var t;if(r.line<3&&document.querySelector&&(t=i.display.wrapper.querySelector(".CodeMirror-dialog"))&&t.getBoundingClientRect().bottom-4>i.cursorCoords(r,"window").top){(a=t).style.opacity=.4}})};u(i,v(i),o,s,function(e,r){var t=l.keyName(e);var n=i.getOption("extraKeys"),o=n&&n[t]||l.keyMap[i.getOption("keyMap")][t];if(o=="findNext"||o=="findPrev"||o=="findPersistentNext"||o=="findPersistentPrev"){l.e_stop(e);h(i,c(i),r);i.execCommand(o)}else if(o=="find"||o=="findPersistent"){l.e_stop(e);s(r,e)}});if(t&&o){h(i,n,o);y(i,r)}}else{p(i,v(i),"Search for:",o,function(e){if(e&&!n.query){i.operation(function(){h(i,n,e);n.posFrom=n.posTo=i.getCursor();y(i,r)})}})}}function y(t,n,o){t.operation(function(){var e=c(t);var r=f(t,e.query,n?e.posFrom:e.posTo);if(!r.find(n)){r=f(t,e.query,n?l.Pos(t.lastLine()):l.Pos(t.firstLine(),0));if(!r.find(n)){return}}t.setSelection(r.from(),r.to());t.scrollIntoView({from:r.from(),to:r.to()},20);e.posFrom=r.from();e.posTo=r.to();if(o){o(r.from(),r.to())}})}function g(r){r.operation(function(){var e=c(r);e.lastQuery=e.query;if(!e.query){return}e.query=e.queryText=null;r.removeOverlay(e.overlay);if(e.annotate){e.annotate.clear();e.annotate=null}})}function a(e,r){var t=e?document.createElement(e):document.createDocumentFragment();for(var n in r){t[n]=r[n]}for(var o=2;o<arguments.length;o++){var i=arguments[o];t.appendChild(typeof i=="string"?document.createTextNode(i):i)}return t}function v(e){var r=a("label",{className:"CodeMirror-search-label"},e.phrase("Search:"),a("input",{type:"text",style:"width: 10em",className:"CodeMirror-search-field",id:"CodeMirror-search-field"}));r.setAttribute("for","CodeMirror-search-field");return a("",null,r," ",a("span",{style:"color: #666",className:"CodeMirror-search-hint"},e.phrase("(Use /re/ syntax for regexp search)")))}function x(e){return a("",null," ",a("input",{type:"text",style:"width: 10em",className:"CodeMirror-search-field"})," ",a("span",{style:"color: #666",className:"CodeMirror-search-hint"},e.phrase("(Use /re/ syntax for regexp search)")))}function C(e){return a("",null,a("span",{className:"CodeMirror-search-label"},e.phrase("With:"))," ",a("input",{type:"text",style:"width: 10em",className:"CodeMirror-search-field"}))}function b(e){return a("",null,a("span",{className:"CodeMirror-search-label"},e.phrase("Replace?"))," ",a("button",{},e.phrase("Yes"))," ",a("button",{},e.phrase("No"))," ",a("button",{},e.phrase("All"))," ",a("button",{},e.phrase("Stop")))}function q(r,n,o){r.operation(function(){for(var e=f(r,n);e.findNext();){if(typeof n!="string"){var t=r.getRange(e.from(),e.to()).match(n);e.replace(o.replace(/\$(\d)/g,function(e,r){return t[r]}))}else{e.replace(o)}}})}function s(s,e){if(s.getOption("readOnly")){return}var r=s.getSelection()||c(s).lastQuery;var t=e?s.phrase("Replace all:"):s.phrase("Replace:");var n=a("",null,a("span",{className:"CodeMirror-search-label"},t),x(s));p(s,n,t,r,function(a){if(!a){return}a=i(a);p(s,C(s),s.phrase("Replace with:"),"",function(n){n=m(n);if(e){q(s,a,n)}else{g(s);var o=f(s,a,s.getCursor("from"));var i=function(){var e=o.from(),r;if(!(r=o.findNext())){o=f(s,a);if(!(r=o.findNext())||e&&o.from().line==e.line&&o.from().ch==e.ch){return}}s.setSelection(o.from(),o.to());s.scrollIntoView({from:o.from(),to:o.to()});d(s,b(s),s.phrase("Replace?"),[function(){t(r)},i,function(){q(s,a,n)}])};var t=function(t){o.replace(typeof a=="string"?n:n.replace(/\$(\d)/g,function(e,r){return t[r]}));i()};i()}})})}l.commands.find=function(e){g(e);t(e)};l.commands.findPersistent=function(e){g(e);t(e,false,true)};l.commands.findPersistentNext=function(e){t(e,false,true,true)};l.commands.findPersistentPrev=function(e){t(e,true,true,true)};l.commands.findNext=t;l.commands.findPrev=function(e){t(e,true)};l.commands.clearSearch=g;l.commands.replace=s;l.commands.replaceAll=function(e){s(e,true)}});
// #END
