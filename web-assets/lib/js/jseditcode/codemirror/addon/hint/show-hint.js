// JS-Script (UM): show-hint.js @ 2022-09-20 09:51:30 +0000
(function(t){if(typeof exports=="object"&&typeof module=="object")t(require("../../lib/codemirror"));else if(typeof define=="function"&&define.amd)define(["../../lib/codemirror"],t);else t(CodeMirror)})(function(B){"use strict";var K="CodeMirror-hint";var L="CodeMirror-hint-active";B.showHint=function(t,i,e){if(!i)return t.showHint(e);if(e&&e.async)i.async=true;var n={hint:i};if(e)for(var o in e)n[o]=e[o];return t.showHint(n)};B.defineExtension("showHint",function(t){t=c(this,this.getCursor("start"),t);var i=this.listSelections();if(i.length>1)return;if(this.somethingSelected()){if(!t.hint.supportsSelection)return;for(var e=0;e<i.length;e++)if(i[e].head.line!=i[e].anchor.line)return}if(this.state.completionActive)this.state.completionActive.close();var n=this.state.completionActive=new o(this,t);if(!n.options.hint)return;B.signal(this,"startCompletion",this);n.update(true)});B.defineExtension("closeHint",function(){if(this.state.completionActive)this.state.completionActive.close()});function o(t,i){this.cm=t;this.options=i;this.widget=null;this.debounce=0;this.tick=0;this.startPos=this.cm.getCursor("start");this.startLen=this.cm.getLine(this.startPos.line).length-this.cm.getSelection().length;if(this.options.updateOnCursorActivity){var e=this;t.on("cursorActivity",this.activityFunc=function(){e.cursorActivity()})}}var s=window.requestAnimationFrame||function(t){return setTimeout(t,1e3/60)};var r=window.cancelAnimationFrame||clearTimeout;o.prototype={close:function(){if(!this.active())return;this.cm.state.completionActive=null;this.tick=null;if(this.options.updateOnCursorActivity){this.cm.off("cursorActivity",this.activityFunc)}if(this.widget&&this.data)B.signal(this.data,"close");if(this.widget)this.widget.close();B.signal(this.cm,"endCompletion",this.cm)},active:function(){return this.cm.state.completionActive==this},pick:function(t,i){var e=t.list[i],n=this;this.cm.operation(function(){if(e.hint)e.hint(n.cm,t,e);else n.cm.replaceRange(U(e),e.from||t.from,e.to||t.to,"complete");B.signal(t,"pick",e);n.cm.scrollIntoView()});if(this.options.closeOnPick){this.close()}},cursorActivity:function(){if(this.debounce){r(this.debounce);this.debounce=0}var t=this.startPos;if(this.data){t=this.data.from}var i=this.cm.getCursor(),e=this.cm.getLine(i.line);if(i.line!=this.startPos.line||e.length-i.ch!=this.startLen-this.startPos.ch||i.ch<t.ch||this.cm.somethingSelected()||(!i.ch||this.options.closeCharacters.test(e.charAt(i.ch-1)))){this.close()}else{var n=this;this.debounce=s(function(){n.update()});if(this.widget)this.widget.disable()}},update:function(i){if(this.tick==null)return;var e=this,n=++this.tick;h(this.options.hint,this.cm,this.options,function(t){if(e.tick==n)e.finishUpdate(t,i)})},finishUpdate:function(t,i){if(this.data)B.signal(this.data,"update");var e=this.widget&&this.widget.picked||i&&this.options.completeSingle;if(this.widget)this.widget.close();this.data=t;if(t&&t.list.length){if(e&&t.list.length==1){this.pick(t,0)}else{this.widget=new n(this,t);B.signal(t,"shown")}}}};function c(t,i,e){var n=t.options.hintOptions;var o={};for(var s in a)o[s]=a[s];if(n)for(var s in n)if(n[s]!==undefined)o[s]=n[s];if(e)for(var s in e)if(e[s]!==undefined)o[s]=e[s];if(o.hint.resolve)o.hint=o.hint.resolve(t,i);return o}function U(t){if(typeof t=="string")return t;else return t.text}function D(t,n){var o={Up:function(){n.moveFocus(-1)},Down:function(){n.moveFocus(1)},PageUp:function(){n.moveFocus(-n.menuSize()+1,true)},PageDown:function(){n.moveFocus(n.menuSize()-1,true)},Home:function(){n.setFocus(0)},End:function(){n.setFocus(n.length-1)},Enter:n.pick,Tab:n.pick,Esc:n.close};var i=/Mac/.test(navigator.platform);if(i){o["Ctrl-P"]=function(){n.moveFocus(-1)};o["Ctrl-N"]=function(){n.moveFocus(1)}}var e=t.options.customKeys;var s=e?{}:o;function r(t,i){var e;if(typeof i!="string")e=function(t){return i(t,n)};else if(o.hasOwnProperty(i))e=o[i];else e=i;s[t]=e}if(e)for(var c in e)if(e.hasOwnProperty(c))r(c,e[c]);var l=t.options.extraKeys;if(l)for(var c in l)if(l.hasOwnProperty(c))r(c,l[c]);return s}function z(t,i){while(i&&i!=t){if(i.nodeName.toUpperCase()==="LI"&&i.parentNode==t)return i;i=i.parentNode}}function n(o,t){this.completion=o;this.data=t;this.picked=false;var e=this,s=o.cm;var r=s.getInputField().ownerDocument;var c=r.defaultView||r.parentWindow;var l=this.hints=r.createElement("ul");var i=o.cm.options.theme;l.className="CodeMirror-hints "+i;this.selectedHint=t.selectedHint||0;var n=t.list;for(var h=0;h<n.length;++h){var a=l.appendChild(r.createElement("li")),f=n[h];var u=K+(h!=this.selectedHint?"":" "+L);if(f.className!=null)u=f.className+" "+u;a.className=u;if(f.render)f.render(a,t,f);else a.appendChild(r.createTextNode(f.displayText||U(f)));a.hintId=h}var p=o.options.container||r.body;var d=s.cursorCoords(o.options.alignWithWord?t.from:null);var m=d.left,v=d.bottom,g=true;var y=0,w=0;if(p!==r.body){var H=["absolute","relative","fixed"].indexOf(c.getComputedStyle(p).position)!==-1;var C=H?p:p.offsetParent;var b=C.getBoundingClientRect();var k=r.body.getBoundingClientRect();y=b.left-k.left-C.scrollLeft;w=b.top-k.top-C.scrollTop}l.style.left=m-y+"px";l.style.top=v-w+"px";var A=c.innerWidth||Math.max(r.body.offsetWidth,r.documentElement.offsetWidth);var S=c.innerHeight||Math.max(r.body.offsetHeight,r.documentElement.offsetHeight);p.appendChild(l);var x=o.options.moveOnOverlap?l.getBoundingClientRect():new DOMRect;var T=o.options.paddingForScrollbar?l.scrollHeight>l.clientHeight+1:false;var O;setTimeout(function(){O=s.getScrollInfo()});var M=x.bottom-S;if(M>0){var F=x.bottom-x.top,N=d.top-(d.bottom-x.top);if(N-F>0){l.style.top=(v=d.top-F-w)+"px";g=false}else if(F>S){l.style.height=S-5+"px";l.style.top=(v=d.bottom-x.top-w)+"px";var P=s.getCursor();if(t.from.ch!=P.ch){d=s.cursorCoords(P);l.style.left=(m=d.left-y)+"px";x=l.getBoundingClientRect()}}}var E=x.right-A;if(T)E+=s.display.nativeBarWidth;if(E>0){if(x.right-x.left>A){l.style.width=A-5+"px";E-=x.right-x.left-A}l.style.left=(m=d.left-E-y)+"px"}if(T)for(var W=l.firstChild;W;W=W.nextSibling)W.style.paddingRight=s.display.nativeBarWidth+"px";s.addKeyMap(this.keyMap=D(o,{moveFocus:function(t,i){e.changeActive(e.selectedHint+t,i)},setFocus:function(t){e.changeActive(t)},menuSize:function(){return e.screenAmount()},length:n.length,close:function(){o.close()},pick:function(){e.pick()},data:t}));if(o.options.closeOnUnfocus){var I;s.on("blur",this.onBlur=function(){I=setTimeout(function(){o.close()},100)});s.on("focus",this.onFocus=function(){clearTimeout(I)})}s.on("scroll",this.onScroll=function(){var t=s.getScrollInfo(),i=s.getWrapperElement().getBoundingClientRect();if(!O)O=s.getScrollInfo();var e=v+O.top-t.top;var n=e-(c.pageYOffset||(r.documentElement||r.body).scrollTop);if(!g)n+=l.offsetHeight;if(n<=i.top||n>=i.bottom)return o.close();l.style.top=e+"px";l.style.left=m+O.left-t.left+"px"});B.on(l,"dblclick",function(t){var i=z(l,t.target||t.srcElement);if(i&&i.hintId!=null){e.changeActive(i.hintId);e.pick()}});B.on(l,"click",function(t){var i=z(l,t.target||t.srcElement);if(i&&i.hintId!=null){e.changeActive(i.hintId);if(o.options.completeOnSingleClick)e.pick()}});B.on(l,"mousedown",function(){setTimeout(function(){s.focus()},20)});var R=this.getSelectedHintRange();if(R.from!==0||R.to!==0){this.scrollToActive()}B.signal(t,"select",n[this.selectedHint],l.childNodes[this.selectedHint]);return true}n.prototype={close:function(){if(this.completion.widget!=this)return;this.completion.widget=null;if(this.hints.parentNode)this.hints.parentNode.removeChild(this.hints);this.completion.cm.removeKeyMap(this.keyMap);var t=this.completion.cm;if(this.completion.options.closeOnUnfocus){t.off("blur",this.onBlur);t.off("focus",this.onFocus)}t.off("scroll",this.onScroll)},disable:function(){this.completion.cm.removeKeyMap(this.keyMap);var t=this;this.keyMap={Enter:function(){t.picked=true}};this.completion.cm.addKeyMap(this.keyMap)},pick:function(){this.completion.pick(this.data,this.selectedHint)},changeActive:function(t,i){if(t>=this.data.list.length)t=i?this.data.list.length-1:0;else if(t<0)t=i?0:this.data.list.length-1;if(this.selectedHint==t)return;var e=this.hints.childNodes[this.selectedHint];if(e)e.className=e.className.replace(" "+L,"");e=this.hints.childNodes[this.selectedHint=t];e.className+=" "+L;this.scrollToActive();B.signal(this.data,"select",this.data.list[this.selectedHint],e)},scrollToActive:function(){var t=this.getSelectedHintRange();var i=this.hints.childNodes[t.from];var e=this.hints.childNodes[t.to];var n=this.hints.firstChild;if(i.offsetTop<this.hints.scrollTop)this.hints.scrollTop=i.offsetTop-n.offsetTop;else if(e.offsetTop+e.offsetHeight>this.hints.scrollTop+this.hints.clientHeight)this.hints.scrollTop=e.offsetTop+e.offsetHeight-this.hints.clientHeight+n.offsetTop},screenAmount:function(){return Math.floor(this.hints.clientHeight/this.hints.firstChild.offsetHeight)||1},getSelectedHintRange:function(){var t=this.completion.options.scrollMargin||0;return{from:Math.max(0,this.selectedHint-t),to:Math.min(this.data.list.length-1,this.selectedHint+t)}}};function l(t,i){if(!t.somethingSelected())return i;var e=[];for(var n=0;n<i.length;n++)if(i[n].supportsSelection)e.push(i[n]);return e}function h(t,i,e,n){if(t.async){t(i,n,e)}else{var o=t(i,e);if(o&&o.then)o.then(n);else n(o)}}function t(t,i){var r=t.getHelpers(i,"hint"),e;if(r.length){var n=function(t,e,n){var o=l(t,r);function s(i){if(i==o.length)return e(null);h(o[i],t,n,function(t){if(t&&t.list.length>0)e(t);else s(i+1)})}s(0)};n.async=true;n.supportsSelection=true;return n}else if(e=t.getHelper(t.getCursor(),"hintWords")){return function(t){return B.hint.fromList(t,{words:e})}}else if(B.hint.anyword){return function(t,i){return B.hint.anyword(t,i)}}else{return function(){}}}B.registerHelper("hint","auto",{resolve:t});B.registerHelper("hint","fromList",function(t,i){var e=t.getCursor(),n=t.getTokenAt(e);var o,s=B.Pos(e.line,n.start),r=e;if(n.start<e.ch&&/\w/.test(n.string.charAt(e.ch-n.start-1))){o=n.string.substr(0,e.ch-n.start)}else{o="";s=e}var c=[];for(var l=0;l<i.words.length;l++){var h=i.words[l];if(h.slice(0,o.length)==o)c.push(h)}if(c.length)return{list:c,from:s,to:r}});B.commands.autocomplete=B.showHint;var a={hint:B.hint.auto,completeSingle:true,alignWithWord:true,closeCharacters:/[\s()\[\]{};:>,]/,closeOnPick:true,closeOnUnfocus:true,updateOnCursorActivity:true,completeOnSingleClick:true,container:null,customKeys:null,extraKeys:null,paddingForScrollbar:true,moveOnOverlap:true};B.defineOption("hintOptions",null)});
// #END
