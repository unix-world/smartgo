// JS-Script (UM): search.js @ 2022-09-20 09:51:36 +0000
(function(e){if(typeof exports=="object"&&typeof module=="object")e(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog"));else if(typeof define=="function"&&define.amd)define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],e);else e(CodeMirror)})(function(c){"use strict";c.defineOption("search",{bottom:false});function n(t,e){if(typeof t=="string")t=new RegExp(t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),e?"gi":"g");else if(!t.global)t=new RegExp(t.source,t.ignoreCase?"gi":"g");return{token:function(e){t.lastIndex=e.pos;var r=t.exec(e.string);if(r&&r.index==e.pos){e.pos+=r[0].length||1;return"searching"}else if(r){e.pos=r.index}else{e.skipToEnd()}}}}function r(){this.posFrom=this.posTo=this.lastQuery=this.query=null;this.overlay=null}function f(e){return e.state.search||(e.state.search=new r)}function o(e){return typeof e=="string"&&e==e.toLowerCase()}function u(e,r,t){return e.getSearchCursor(r,t,{caseFold:o(r),multiline:true})}function l(e,r,t,n,o){e.openDialog(r,n,{value:t,selectValueOnOpen:true,closeOnEnter:false,onClose:function(){g(e)},onKeyDown:o,bottom:e.options.search.bottom})}function p(e,r,t,n,o){if(e.openDialog)e.openDialog(r,o,{value:n,selectValueOnOpen:true,bottom:e.options.search.bottom});else o(prompt(t,n))}function d(e,r,t,n){if(e.openConfirm)e.openConfirm(r,n);else if(confirm(t))n[0]()}function m(e){return e.replace(/\\([nrt\\])/g,function(e,r){if(r=="n")return"\n";if(r=="r")return"\r";if(r=="t")return"\t";if(r=="\\")return"\\";return e})}function i(e){var r=e.match(/^\/(.*)\/([a-z]*)$/);if(r){try{e=new RegExp(r[1],r[2].indexOf("i")==-1?"":"i")}catch(e){}}else{e=m(e)}if(typeof e=="string"?e=="":e.test(""))e=/x^/;return e}function y(e,r,t){r.queryText=t;r.query=i(t);e.removeOverlay(r.overlay,o(r.query));r.overlay=n(r.query,o(r.query));e.addOverlay(r.overlay);if(e.showMatchesOnScrollbar){if(r.annotate){r.annotate.clear();r.annotate=null}r.annotate=e.showMatchesOnScrollbar(r.query,o(r.query))}}function t(i,r,e,t){var n=f(i);if(n.query)return h(i,r);var o=i.getSelection()||n.lastQuery;if(o instanceof RegExp&&o.source=="x^")o=null;if(e&&i.openDialog){var a=null;var s=function(e,r){c.e_stop(r);if(!e)return;if(e!=n.queryText){y(i,n,e);n.posFrom=n.posTo=i.getCursor()}if(a)a.style.opacity=1;h(i,r.shiftKey,function(e,r){var t;if(r.line<3&&document.querySelector&&(t=i.display.wrapper.querySelector(".CodeMirror-dialog"))&&t.getBoundingClientRect().bottom-4>i.cursorCoords(r,"window").top)(a=t).style.opacity=.4})};l(i,v(i),o,s,function(e,r){var t=c.keyName(e);var n=i.getOption("extraKeys"),o=n&&n[t]||c.keyMap[i.getOption("keyMap")][t];if(o=="findNext"||o=="findPrev"||o=="findPersistentNext"||o=="findPersistentPrev"){c.e_stop(e);y(i,f(i),r);i.execCommand(o)}else if(o=="find"||o=="findPersistent"){c.e_stop(e);s(r,e)}});if(t&&o){y(i,n,o);h(i,r)}}else{p(i,v(i),"Search for:",o,function(e){if(e&&!n.query)i.operation(function(){y(i,n,e);n.posFrom=n.posTo=i.getCursor();h(i,r)})})}}function h(t,n,o){t.operation(function(){var e=f(t);var r=u(t,e.query,n?e.posFrom:e.posTo);if(!r.find(n)){r=u(t,e.query,n?c.Pos(t.lastLine()):c.Pos(t.firstLine(),0));if(!r.find(n))return}t.setSelection(r.from(),r.to());t.scrollIntoView({from:r.from(),to:r.to()},20);e.posFrom=r.from();e.posTo=r.to();if(o)o(r.from(),r.to())})}function g(r){r.operation(function(){var e=f(r);e.lastQuery=e.query;if(!e.query)return;e.query=e.queryText=null;r.removeOverlay(e.overlay);if(e.annotate){e.annotate.clear();e.annotate=null}})}function v(e){return'<span class="CodeMirror-search-label">'+e.phrase("Search:")+'</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">'+e.phrase("(Use /re/ syntax for regexp search)")+"</span>"}function a(e){return' <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">'+e.phrase("(Use /re/ syntax for regexp search)")+"</span>"}function x(e){return'<span class="CodeMirror-search-label">'+e.phrase("With:")+'</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/>'}function b(e){return'<span class="CodeMirror-search-label">'+e.phrase("Replace?")+"</span> <button>"+e.phrase("Yes")+"</button> <button>"+e.phrase("No")+"</button> <button>"+e.phrase("All")+"</button> <button>"+e.phrase("Stop")+"</button> "}function C(r,n,o){r.operation(function(){for(var e=u(r,n);e.findNext();){if(typeof n!="string"){var t=r.getRange(e.from(),e.to()).match(n);e.replace(o.replace(/\$(\d)/g,function(e,r){return t[r]}))}else e.replace(o)}})}function s(s,e){if(s.getOption("readOnly"))return;var r=s.getSelection()||f(s).lastQuery;var t='<span class="CodeMirror-search-label">'+(e?s.phrase("Replace all:"):s.phrase("Replace:"))+"</span>";p(s,t+a(s),t,r,function(a){if(!a)return;a=i(a);p(s,x(s),s.phrase("Replace with:"),"",function(n){n=m(n);if(e){C(s,a,n)}else{g(s);var o=u(s,a,s.getCursor("from"));var i=function(){var e=o.from(),r;if(!(r=o.findNext())){o=u(s,a);if(!(r=o.findNext())||e&&o.from().line==e.line&&o.from().ch==e.ch)return}s.setSelection(o.from(),o.to());s.scrollIntoView({from:o.from(),to:o.to()});d(s,b(s),s.phrase("Replace?"),[function(){t(r)},i,function(){C(s,a,n)}])};var t=function(t){o.replace(typeof a=="string"?n:n.replace(/\$(\d)/g,function(e,r){return t[r]}));i()};i()}})})}c.commands.find=function(e){g(e);t(e)};c.commands.findPersistent=function(e){g(e);t(e,false,true)};c.commands.findPersistentNext=function(e){t(e,false,true,true)};c.commands.findPersistentPrev=function(e){t(e,true,true,true)};c.commands.findNext=t;c.commands.findPrev=function(e){t(e,true)};c.commands.clearSearch=g;c.commands.replace=s;c.commands.replaceAll=function(e){s(e,true)}});
// #END
